<launch>

  <arg name="INPUT_CLOUD" />


  <arg name="MANAGER" value="recognition_in_hand_manager" />
  <node name="$(arg MANAGER)"
        pkg="nodelet" type="nodelet" args="manager" />


  <node name="in_hand_clipper"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/AttentionClipper $(arg MANAGER)"
        clear_params="true">
    <remap from="~input/points" to="$(arg INPUT_CLOUD)" />
    <rosparam>
      use_multiple_attention: true
      initial_pos_list: [[0.0, -0.1, 0.3], [0.0, -0.1, 0.3]]
      initial_rot_list: [[0, 0, 0], [0, 0, 0]]
      dimensions: [[0.3, 0.2, 0.3], [0.3, 0.2, 0.3]]
      frame_id_list: [left_custom_vacuum_link_base, right_custom_vacuum_link_base]
      prefixes: [left_hand, right_hand]
    </rosparam>
  </node>


  <!-- debug info -->
  <node name="extract_indices_left_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/ExtractIndices $(arg MANAGER)">
    <remap from="~input" to="$(arg INPUT_CLOUD)" />
    <remap from="~indices" to="in_hand_clipper/left_hand/point_indices" />
    <remap from="~output" to="~points" />
    <rosparam>
      keep_organized: true
    </rosparam>
  </node>
  <node name="extract_indices_right_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/ExtractIndices $(arg MANAGER)">
    <remap from="~input" to="$(arg INPUT_CLOUD)" />
    <remap from="~indices" to="in_hand_clipper/right_hand/point_indices" />
    <remap from="~output" to="~points" />
    <rosparam>
      keep_organized: true
    </rosparam>
  </node>


  <!-- self filter -->
  <include file="$(find jsk_2015_05_baxter_apc)/launch/include/self_filter.launch">
    <arg name="INPUT_CLOUD" value="extract_indices_left_hand/points" />
    <arg name="OUTPUT_CLOUD" value="extract_indices_left_hand/points_filtered" />
  </include>
  <include file="$(find jsk_2015_05_baxter_apc)/launch/include/self_filter.launch">
    <arg name="INPUT_CLOUD" value="extract_indices_right_hand/points" />
    <arg name="OUTPUT_CLOUD" value="extract_indices_right_hand/points_filtered" />
  </include>


  <node name="pc_to_pi_left_hand"
        pkg="nodelet" type="nodelet"
        args="standalone jsk_pcl/OrganizedPointCloudToPointIndices $(arg MANAGER)">
    <remap from="~input" to="extract_indices_left_hand/points_filtered" />
  </node>
  <node name="pc_to_pi_right_hand"
        pkg="nodelet" type="nodelet"
        args="standalone jsk_pcl/OrganizedPointCloudToPointIndices $(arg MANAGER)">
    <remap from="~input" to="extract_indices_right_hand/points_filtered" />
  </node>


  <!-- object segmented image -->
  <!-- convert point indices to mask image -->
  <node name="pi_to_mask_left_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/PointIndicesToMaskImage $(arg MANAGER)">
    <remap from="~input" to="pc_to_pi_left_hand/output" />
    <remap from="~input/image" to="/kinect2_head/hd/image_color" />
    <rosparam>
      approximate_sync: true
    </rosparam>
  </node>
  <node name="pi_to_mask_right_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/PointIndicesToMaskImage $(arg MANAGER)">
    <remap from="~input" to="pc_to_pi_right_hand/output" />
    <remap from="~input/image" to="/kinect2_head/hd/image_color" />
    <rosparam>
      approximate_sync: true
    </rosparam>
  </node>
  <!-- process mask image -->
  <node name="closing_left_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_perception/Closing $(arg MANAGER)">
    <remap from="~input" to="pi_to_mask_left_hand/output" />
    <rosparam>
      approximate_sync: true
      size: 8
      iterations: 4
    </rosparam>
  </node>
  <node name="closing_right_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_perception/Closing $(arg MANAGER)">
    <remap from="~input" to="pi_to_mask_right_hand/output" />
    <rosparam>
      approximate_sync: true
      size: 8
      iterations: 4
    </rosparam>
  </node>
  <!-- apply mask image -->
  <node name="apply_mask_left_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_perception/ApplyMaskImage $(arg MANAGER)">
    <remap from="~input" to="/kinect2_head/hd/image_color" />
    <remap from="~input/mask" to="closing_left_hand/output" />
    <rosparam>
      approximate_sync: true
    </rosparam>
  </node>
  <node name="apply_mask_right_hand"
        pkg="nodelet" type="nodelet"
        args="load jsk_perception/ApplyMaskImage $(arg MANAGER)">
    <remap from="~input" to="/kinect2_head/hd/image_color" />
    <remap from="~input/mask" to="closing_right_hand/output" />
    <rosparam>
      approximate_sync: true
    </rosparam>
  </node>

  <!-- object recognition -->
  <group ns="left_hand">
    <include file="$(find jsk_2015_05_baxter_apc)/launch/include/object_recognition.launch">
      <arg name="INPUT_IMAGE" value="/apply_mask_left_hand/output" />
    </include>
  </group>
  <group ns="right_hand">
    <include file="$(find jsk_2015_05_baxter_apc)/launch/include/object_recognition.launch">
      <arg name="INPUT_IMAGE" value="/apply_mask_right_hand/output" />
    </include>
  </group>


</launch>
